# AlmaChat V0.5 Plan â€” Social & UX Enhancement

## Overview
AlmaChat v0.5 focuses on **Social & UX Enhancement**: message reactions, user profiles, unread badges, channel management, and deep links. This transforms the app from a basic chat client into a feature-rich social messaging experience.

## Implementation Order
A (Reactions) â†’ C (Unread Badge) â†’ B (Profile/Channel Info) â†’ D (Safety) â†’ E (Deep Links)

---

## Phase A: Message Actions & Reactions (1-2 sessions, ~810 lines)

### Status: ğŸ”µ In Progress (Session 114 ì‹œì‘)

### Goal
Add long-press message actions (copy, delete, reply) and emoji reactions to messages.

### Key Challenge
`TranslatedMessage` (892 lines) is a fully custom widget that **bypasses Stream SDK's built-in message interaction**. We must add interaction layers around this custom widget.

### New Files (3) âœ… Created
1. **`lib/widgets/reaction_picker.dart`** âœ…
   - Horizontal emoji row (ğŸ‘ â¤ï¸ ğŸ˜‚ ğŸ˜® ğŸ˜¢ ğŸ™)
   - `onReactionSelected` callback

2. **`lib/widgets/reaction_bar.dart`** âœ…
   - Grouped reaction counts below message bubble
   - Uses `message.reactionGroups` (not deprecated `reactionCounts`)
   - Tap own reaction to remove, tap others to add same

3. **`lib/widgets/message_actions_sheet.dart`** âœ…
   - Bottom sheet: ReactionPicker + Copy + Reply + Delete
   - Delete with confirmation dialog
   - Uses `channel.sendReaction()`, `channel.deleteReaction()`, `channel.deleteMessage()`

### Modified Files (4) â€” Partially Done
4. **`lib/widgets/translated_message.dart`** âœ… Modified
   - Added `onLongPress`, `onReply`, `currentUserId`, `channel` parameters
   - Wrapped message with `GestureDetector(onLongPress: ...)`
   - Added `ReactionBar` below footer
   - Added `_handleReactionTap()` method

5. **`lib/screens/chat_screen.dart`** ğŸ”² TODO
   - Pass callbacks to `TranslatedMessage`
   - Show `MessageActionsSheet` on long-press
   - Wire reply to `StreamMessageInput.quotedMessage`

6. **`lib/screens/meetup_chat_screen.dart`** ğŸ”² TODO
   - Same wiring as chat_screen

7. **`lib/l10n/app_strings.dart`** ğŸ”² TODO
   - 10 new keys Ã— 15 languages = 150 entries
   - Keys: `message.copy`, `message.delete`, `message.reply`, `message.deleteConfirm`, `message.deleteConfirmDesc`, `message.copied`, `message.replyTo`, `message.react`, `message.deleteForEveryone`, `message.actions`

### Stream SDK APIs Used
- `channel.sendReaction(message, type)` â€” add reaction
- `channel.deleteReaction(message, reaction)` â€” remove reaction
- `channel.deleteMessage(message)` â€” delete message
- `message.reactionGroups` â€” read reaction counts (v9.5+)
- `message.latestReactions` â€” check user's own reactions

---

## Phase C: Unread Badge & Chat UX Polish (1 session, ~230 lines)

### Status: ğŸ”² Pending

### Goal
Show unread message count badge on bottom nav chat tab, add scroll-to-bottom FAB in chat.

### Modified Files (5)
1. **`lib/main.dart`** (~+60 lines)
   - `StreamBuilder` on `client.state.totalUnreadCountStream`
   - Red badge with count on Chat tab icon

2. **`lib/screens/chat_screen.dart`** (~+50 lines)
   - Scroll-to-bottom FAB with new message count badge

3. **`lib/screens/meetup_chat_screen.dart`** (~+50 lines)
   - Same scroll-to-bottom FAB

4. **`lib/screens/channel_list_screen.dart`** (~+20 lines)
   - `channel.markRead()` when channel tapped

5. **`lib/l10n/app_strings.dart`** (~+45 lines)
   - 3 keys Ã— 15 languages

---

## Phase B: User Profile Viewer & Channel Info (1-2 sessions, ~1035 lines)

### Status: ğŸ”² Pending

### Goal
Tap user avatar to see profile sheet. Tap channel name to see channel details.

### New Files (2)
1. **`lib/widgets/user_profile_sheet.dart`** (~250 lines)
2. **`lib/screens/channel_info_screen.dart`** (~350 lines)

### New Backend APIs (2)
3. **`chat/api/mute-channel.ts`** (~40 lines)
4. **`chat/api/block-user.ts`** (~50 lines)

### Modified Files (5)
5. `translated_message.dart` â€” `onAvatarTap` callback
6. `chat_screen.dart` â€” AppBar title â†’ ChannelInfoScreen
7. `meetup_chat_screen.dart` â€” same
8. `find_friends_screen.dart` â€” tap â†’ UserProfileSheet
9. `app_strings.dart` â€” 15 keys Ã— 15 languages

---

## Phase D: Channel Management & Safety (1 session, ~400 lines)

### Status: ğŸ”² Pending

### Goal
Long-press channel tile for actions (pin, mute, leave).

### New Files (1)
1. **`lib/widgets/channel_actions_sheet.dart`** (~150 lines)

### Modified Files (3)
2. `channel_list_screen.dart` â€” onLongPress, pinned sorting
3. `chat_screen.dart` â€” muted indicator
4. `app_strings.dart` â€” 10 keys Ã— 15 languages

---

## Phase E: Deep Links & Polish (1 session, ~188 lines)

### Status: ğŸ”² Pending

### Goal
Handle `almachat://invite/{code}` deep links. Pull-to-refresh.

### New Files (1)
1. **`lib/services/deep_link_service.dart`** (~80 lines)

### Modified Files (4)
2. `main.dart` â€” initialize DeepLinkService
3. `channel_list_screen.dart` â€” RefreshIndicator
4. `pubspec.yaml` â€” `app_links` package
5. `app_strings.dart` â€” 5 keys Ã— 15 languages

---

## Summary

| Phase | New Files | Modified Files | Est. Lines | Sessions | Status |
|-------|-----------|---------------|------------|----------|--------|
| A: Reactions | 3 | 4 | ~810 | 1-2 | ğŸ”µ In Progress |
| C: Unread Badge | 0 | 5 | ~230 | 1 | ğŸ”² Pending |
| B: Profile/Info | 2 + 2 APIs | 5 | ~1,035 | 1-2 | ğŸ”² Pending |
| D: Safety | 1 | 3 | ~400 | 1 | ğŸ”² Pending |
| E: Deep Links | 1 | 4 | ~188 | 1 | ğŸ”² Pending |
| **Total** | **7 + 2 APIs** | **~15** | **~2,663** | **5-7** | |

## Constraints
- All UI uses `context.alma` semantic tokens (no hardcoded colors)
- All text uses `tr(key, lang)` with 15 languages
- Stream SDK client-side APIs preferred; server-side only for ban/mute requiring auth
- No breaking changes to existing functionality
- `TranslatedMessage` widget extended, not replaced
- Use `reactionGroups` (not deprecated `reactionCounts`) for Stream SDK v9.5+
