# AlmaChat V0.2 - Feature Upgrade Plan

> Session 92 (2026-02-16) 수립

## Overview

AlmaChat을 단순 채팅앱에서 **Kindness SNS 플랫폼**으로 확장하는 V0.2 업데이트 계획.
Stream Chat SDK의 네이티브 기능을 최대한 활용하여 구현.

---

## Stream Chat SDK 기능 지원 현황

| 기능 | SDK 지원 | API/위젯 | 커스텀 작업 |
|------|:--------:|----------|:-----------:|
| 프로필 사진 업로드 | ✅ | `client.partialUpdateUser()` | 중간 |
| 메시지 아바타 표시 | ✅ | `StreamUserAvatar` 위젯 | 낮음 |
| 사용자 검색 | ✅ | `client.queryUsers()` | 중간 |
| 1:1 DM (distinct channel) | ✅ | 멤버 기반 distinct 채널 | 중간 |
| 채널 초대 (사용자 기반) | ✅ | `channel.inviteMembers()` | 낮음 |
| 초대 링크 (URL 기반) | ❌ | 커스텀 구현 필요 | 높음 |
| 커스텀 채널 타입 (meetup) | ✅ | 서버 사이드 생성 | 낮음 |
| 채널 extraData | ✅ | `channel.updatePartial()` | 낮음 |

---

## 구현 단계 (7 Steps)

### Step 1: 프로필 사진 업로드 (Profile Photo)
**목표**: 사용자가 갤러리/카메라에서 사진을 선택하여 프로필 이미지로 설정

**작업 내역**:
1. `image_picker` 패키지 추가
2. `profile_screen.dart` - 아바타 탭 → 이미지 선택 바텀시트 (갤러리/카메라)
3. 이미지 업로드 → Stream CDN URL 획득
4. `client.partialUpdateUser(set: {'image': cdnUrl})` 호출
5. `auth_service.dart` - 프로필 이미지 URL 관리

**Stream SDK 활용**:
- `client.sendImage()` → Stream CDN에 업로드
- `client.partialUpdateUser()` → 사용자 이미지 업데이트
- `StreamUserAvatar` → 업데이트된 이미지 자동 반영

**신규 패키지**: `image_picker: ^1.1.2`

**예상 변경 파일**:
- `pubspec.yaml` (image_picker 추가)
- `lib/screens/profile_screen.dart` (업로드 UI + 로직)
- `lib/services/auth_service.dart` (이미지 URL 관리)

---

### Step 2: 채팅 메시지 아바타 표시 (Message Avatars)
**목표**: 대화창에서 상대방 메시지 왼쪽에 프로필 사진 작게 표시

**작업 내역**:
1. `translated_message.dart` - 상대방 메시지에 `StreamUserAvatar` 추가
2. 아바타 크기: 28~32dp, 메시지 버블 왼쪽 배치
3. 연속 같은 사용자 메시지 시 아바타 숨김 (grouping)
4. 사용자 이름 + 아바타 결합 레이아웃

**Stream SDK 활용**:
- `StreamUserAvatar(user: message.user!, constraints: BoxConstraints.tight(Size(32, 32)))`
- `message.user?.image` → 이미지 URL (없으면 이니셜 fallback 자동)

**예상 변경 파일**:
- `lib/widgets/translated_message.dart` (아바타 추가)

---

### Step 3: 사용자 검색 & 1:1 DM (Friend Finder)
**목표**: 사용자를 검색하여 1:1 개인 채팅 시작

**작업 내역**:
1. `find_friends_screen.dart` 신규 생성
   - 검색 입력 → `client.queryUsers(filter: Filter.autoComplete('name', query))`
   - 사용자 리스트 (이름, 아바타, 온라인 상태)
   - 사용자 탭 → 1:1 distinct 채널 생성 → 채팅화면 이동
2. `channel_list_screen.dart` - 친구찾기 FAB 또는 상단 버튼 추가
3. 1:1 채널 생성 (distinct):
   ```dart
   client.channel('messaging', extraData: {'members': [myId, friendId]})
   ```
4. 채널 리스트에서 DM vs 그룹 구분 표시

**Stream SDK 활용**:
- `client.queryUsers()` → 사용자 검색 (이름 자동완성)
- Distinct channel → 같은 쌍이면 기존 채널 반환 (중복 방지)
- `StreamUserAvatar` → 검색 결과 아바타

**신규 파일**:
- `lib/screens/find_friends_screen.dart`

**예상 변경 파일**:
- `lib/screens/channel_list_screen.dart` (친구찾기 진입점)
- `lib/main.dart` (라우트 추가)

---

### Step 4: 채널 초대 링크 (Invite Links)
**목표**: 채팅방 공유 가능한 초대 링크 생성 & 링크로 채팅방 참여

**작업 내역**:
1. **백엔드 API**:
   - `chat/api/create-invite.ts` - 초대 코드 생성 (Supabase `invite_links` 테이블)
   - `chat/api/join-invite.ts` - 초대 코드 검증 & 채널 참여
2. **DB 테이블**: `invite_links` (code, channel_id, created_by, expires_at, max_uses, use_count)
3. **Flutter 클라이언트**:
   - 채팅 화면 AppBar → 공유 아이콘 → 초대 링크 생성 & 클립보드 복사
   - `Share.share()` 로 공유
   - 딥링크 처리: `almachat://invite/{code}`
4. **초대 링크 형식**: `https://chat.almaneo.org/invite/{code}`

**Stream SDK 활용**:
- `channel.addMembers([userId])` → 서버 사이드 채널 참여 처리

**신규 파일**:
- `chat/api/create-invite.ts`
- `chat/api/join-invite.ts`

**예상 변경 파일**:
- `lib/screens/chat_screen.dart` (공유 버튼)
- `lib/main.dart` (딥링크 핸들러)
- Supabase migration (invite_links 테이블)

---

### Step 5: 채널 리스트 UI 개선 (DM + Group 구분)
**목표**: 채널 리스트에서 DM과 그룹 채널을 시각적으로 구분

**작업 내역**:
1. 채널 리스트 아이템에 DM 채널은 상대방 아바타 표시
2. 그룹 채널은 채널 아이콘/그룹 아바타 표시
3. 하단 탭 또는 상단 필터: "전체 | DM | 그룹" 구분
4. DM 채널명 = 상대방 이름 자동 표시

**Stream SDK 활용**:
- `channel.memberCount` → DM(2명) vs 그룹(3명+) 구분
- `channel.state?.members` → DM 상대방 정보
- `StreamChannelAvatar` → 채널 아바타 (1:1이면 상대방, 그룹이면 조합)

**예상 변경 파일**:
- `lib/screens/channel_list_screen.dart` (DM/그룹 구분 UI)

---

### Step 6: 밋업 피드 & 대시보드 (Meetup Feed - MVP)
**목표**: 홈 화면에 밋업/Kindness 활동 피드를 보여주는 SNS형 대시보드

**작업 내역**:
1. `home_screen.dart` (또는 `dashboard_screen.dart`) 신규 생성
   - 밋업 포스팅 카드 리스트 (Supabase `meetups` 테이블 조회)
   - 카드: 밋업 제목, 호스트, 날짜, 장소, 참가자 수, 사진
   - 탭 → 밋업 상세 (참가 신청, 채팅방 연결)
2. 하단 네비게이션 바 추가:
   - 🏠 Home (밋업 피드) | 💬 Chat (채널 리스트) | 👤 Profile
3. 밋업 생성 플로우 (간략):
   - 제목, 설명, 날짜, 장소 입력 → Supabase 저장
   - 자동으로 밋업 채팅방 생성 (Stream channel type: 'messaging', extraData에 meetup 메타)
4. Kindness 활동 리포트 카드 (향후 확장)

**Stream SDK 활용**:
- 밋업 생성 시 자동 채팅 채널 생성
- `channel.extraData` 에 밋업 메타데이터 저장 (type: 'meetup', meetup_id 등)

**신규 파일**:
- `lib/screens/home_screen.dart` (밋업 피드 대시보드)
- `lib/services/meetup_service.dart` (Supabase 밋업 CRUD)

**예상 변경 파일**:
- `lib/main.dart` (하단 네비게이션 바 구조 변경)
- `lib/screens/channel_list_screen.dart` (탭 구조로 변경)

---

### Step 7: 밋업 상세 & Kindness 리포트 (Meetup Detail)
**목표**: 밋업 상세 화면에서 참가/검증/채팅 연동

**작업 내역**:
1. `meetup_detail_screen.dart` - 밋업 상세 정보
   - 밋업 정보 (제목, 설명, 날짜, 장소, 호스트)
   - 참가자 목록 (아바타 + 이름)
   - 참가/탈퇴 버튼
   - 밋업 채팅방으로 이동 버튼
   - 사진 업로드 (검증용)
2. `meetup_create_screen.dart` - 밋업 생성 폼
3. Kindness 리포트 카드 (포인트 획득 내역)
4. web의 `meetup.ts` 서비스 로직 재활용 (API 엔드포인트 경유)

**예상 신규 파일**:
- `lib/screens/meetup_detail_screen.dart`
- `lib/screens/meetup_create_screen.dart`

---

## 구현 우선순위 & 예상 작업량

| Step | 기능 | 복잡도 | 우선순위 | SDK 활용도 |
|:----:|------|:------:|:--------:|:----------:|
| 1 | 프로필 사진 업로드 | 중간 | 🔴 높음 | 높음 |
| 2 | 메시지 아바타 표시 | 낮음 | 🔴 높음 | 높음 |
| 3 | 사용자 검색 & 1:1 DM | 중간 | 🔴 높음 | 높음 |
| 4 | 채널 초대 링크 | 높음 | 🟡 중간 | 중간 |
| 5 | 채널 리스트 UI 개선 | 중간 | 🟡 중간 | 높음 |
| 6 | 밋업 피드 대시보드 | 높음 | 🟡 중간 | 중간 |
| 7 | 밋업 상세 & Kindness | 높음 | 🟢 낮음 | 낮음 |

---

## 파일 변경 요약

### 신규 파일 (예상 8개)
```
chat-app/lib/screens/find_friends_screen.dart      # Step 3: 친구찾기
chat-app/lib/screens/home_screen.dart               # Step 6: 밋업 대시보드
chat-app/lib/screens/meetup_detail_screen.dart      # Step 7: 밋업 상세
chat-app/lib/screens/meetup_create_screen.dart      # Step 7: 밋업 생성
chat-app/lib/services/meetup_service.dart           # Step 6-7: 밋업 서비스
chat/api/create-invite.ts                           # Step 4: 초대 생성 API
chat/api/join-invite.ts                             # Step 4: 초대 참여 API
supabase/migrations/xxx_invite_links.sql            # Step 4: 초대 테이블
```

### 수정 파일 (예상 8개)
```
chat-app/pubspec.yaml                              # Step 1: image_picker
chat-app/lib/screens/profile_screen.dart            # Step 1: 사진 업로드 UI
chat-app/lib/services/auth_service.dart             # Step 1: 이미지 관리
chat-app/lib/widgets/translated_message.dart        # Step 2: 아바타 표시
chat-app/lib/screens/channel_list_screen.dart       # Step 3,5: 친구찾기 + DM구분
chat-app/lib/screens/chat_screen.dart               # Step 4: 공유 버튼
chat-app/lib/main.dart                              # Step 3,4,6: 라우트 + 네비
chat-app/lib/l10n/app_strings.dart                  # 전체: i18n 키 추가
```

### 신규 패키지
```yaml
image_picker: ^1.1.2       # Step 1: 이미지 선택
share_plus: ^10.1.4        # Step 4: 공유 기능
```

---

## 기술적 고려사항

### Stream Chat 무료 플랜 제한
- 동시 접속: 25명
- 월 메시지: 10,000건
- 채널 수: 100개
- **간헐적 연결 끊김** → 서버 연결 상태 UI 표시 (오프라인 배너)

### 프로필 이미지 저장소
- Stream CDN 사용 (별도 스토리지 불필요)
- `client.sendImage()` → CDN URL 반환

### DM vs Group 채널 구분
- Distinct 채널 (memberCount=2, ID 없음) = DM
- Named 채널 (ID 있음, memberCount≥2) = Group

### 밋업 데이터
- 기존 `web/src/services/meetup.ts` 로직 참고
- Supabase `meetups` 테이블 직접 쿼리 (supabase_flutter)
- 향후 전용 API 엔드포인트 추가 가능

---

## V0.3+ 향후 확장 — Kindness AI 자동 리포트 시스템

### 핵심 비전

> 밋업의 모든 활동 데이터(녹음, 채팅, 사진, 영상)를 **Kindness AI**가 분석하여
> 자동으로 리포트를 생성하고, 참여자에게 Kindness 점수를 자동 부여하는 시스템.
> 사용자는 밋업에 참여하기만 하면 자동으로 Kindness 활동이 기록되고 보상받는다.

### Kindness AI 파이프라인

```
┌─────────────────────────────────────────────────────────────┐
│                    밋업 활동 데이터 수집                       │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  🎙️ 음성 녹음          📸 사진 업로드        📹 영상 기록     │
│  (미팅 대화 녹음)       (활동 사진들)         (활동 클립)      │
│                                                              │
│  💬 채팅 대화 분석       📍 위치 데이터       👥 참가자 정보   │
│  (Stream 채널 히스토리)  (밋업 장소)          (출석 확인)      │
│                                                              │
└──────────────────────┬──────────────────────────────────────┘
                       ▼
┌─────────────────────────────────────────────────────────────┐
│                    Kindness AI 분석 엔진                      │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  1. 🗣️ Speech-to-Text (음성 → 텍스트 변환)                   │
│     - Whisper / Gemini Audio API                             │
│                                                              │
│  2. 📝 대화 요약 (텍스트 + 채팅 → 핵심 내용 추출)              │
│     - 밋업 주제, 논의 사항, 결정 사항                          │
│     - 참가자별 기여도 분석                                     │
│                                                              │
│  3. 🖼️ 이미지 분석 (사진 → 활동 분류)                         │
│     - 참가 인원 카운트 (얼굴 감지)                             │
│     - 활동 유형 분류 (교육, 봉사, 문화교류, 멘토링)             │
│     - 장소/환경 인식                                          │
│                                                              │
│  4. 🎬 영상 하이라이트 (영상 → 자동 편집 클립)                  │
│     - 핵심 순간 추출                                          │
│     - 짧은 리캡 영상 자동 생성                                 │
│                                                              │
│  5. 📊 Kindness 점수 산정                                     │
│     - 활동 유형별 기본 점수                                    │
│     - 참가 시간, 기여도, 인원수 가중치                          │
│     - AI 감정 분석 기반 보너스 (긍정적 상호작용)                 │
│     - 사진/영상 증빙 보너스                                    │
│                                                              │
└──────────────────────┬──────────────────────────────────────┘
                       ▼
┌─────────────────────────────────────────────────────────────┐
│                    자동 리포트 & 보상                          │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  📄 자동 리포트 포스팅                                        │
│  ├── 밋업 요약 (AI 생성 텍스트)                               │
│  ├── 핵심 사진 선별 (베스트 샷 자동 선택)                      │
│  ├── 하이라이트 영상 클립                                     │
│  ├── 참가자 목록 & 역할                                       │
│  └── Kindness 점수 요약                                      │
│                                                              │
│  🏆 Kindness 점수 자동 전송                                   │
│  ├── 호스트: +80~120점 (인원수 가중치)                        │
│  ├── 참가자: +30~50점 (기여도 가중치)                         │
│  ├── AI 보너스: +10~30점 (활동 품질)                          │
│  └── 온체인 기록 → AmbassadorSBT 자동 업데이트                │
│                                                              │
│  📱 알림 전송                                                 │
│  ├── "밋업 리포트가 생성되었습니다"                             │
│  ├── "Kindness +45점을 획득했습니다!"                         │
│  └── 리포트 포스팅 → 홈 피드에 자동 표시                      │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 자동 점수 산정 로직 (AI 기반)

| 요소 | 기본 점수 | AI 가중치 | 설명 |
|------|:---------:|:---------:|------|
| 밋업 참가 | +30 | ×1.0~1.5 | 참가 시간 비례 |
| 밋업 주최 | +80 | ×1.0~1.5 | 참가 인원 비례 |
| 발언/기여 | +10~20 | AI 분석 | 대화 참여도 분석 |
| 사진 업로드 | +5/장 | - | 증빙 보너스 |
| 영상 기록 | +10/건 | - | 증빙 보너스 |
| 긍정적 상호작용 | +5~15 | AI 감정분석 | 격려, 도움, 공감 발언 |
| 교육/멘토링 | +20~40 | AI 분류 | 지식 공유 활동 |
| 봉사 활동 | +30~50 | AI 분류 | 봉사 관련 활동 |

### 기술 스택 (예상)

| 컴포넌트 | 기술 | 용도 |
|----------|------|------|
| Speech-to-Text | Whisper API / Gemini Audio | 음성 녹음 텍스트 변환 |
| 대화 분석/요약 | Gemini Flash / Claude | 밋업 내용 요약 & 기여도 분석 |
| 이미지 분석 | Gemini Vision | 활동 분류, 인원 카운트 |
| 영상 처리 | FFmpeg + Gemini | 하이라이트 클립 생성 |
| 점수 산정 | 커스텀 로직 + AI | 가중치 기반 점수 계산 |
| 온체인 기록 | AmbassadorSBT 컨트랙트 | 점수 기록 & SBT 업데이트 |
| 저장소 | Supabase Storage | 미디어 파일 저장 |
| 알림 | FCM | 리포트 & 점수 알림 |

### 사용자 플로우

```
1. 밋업 시작
   → 호스트가 "밋업 기록 시작" 버튼 탭
   → 음성 녹음 시작 (백그라운드)
   → 채팅 채널 자동 연결

2. 밋업 진행 중
   → 참가자들 사진/영상 업로드 (밋업 채팅방)
   → 채팅 대화 자동 기록
   → 음성 녹음 계속

3. 밋업 종료
   → 호스트가 "밋업 종료" 버튼 탭
   → 녹음 중단, 데이터 수집 완료

4. AI 분석 (백그라운드, 1~5분)
   → 음성 텍스트 변환
   → 대화 분석 & 요약
   → 이미지 분석
   → 점수 산정

5. 리포트 자동 생성
   → 밋업 요약 포스팅 자동 생성
   → 홈 피드에 게시
   → 참가자에게 알림

6. 점수 자동 전송
   → 참가자별 Kindness 점수 부여
   → AmbassadorSBT 온체인 업데이트
   → "Kindness +45점 획득!" 알림
```

### 기타 V0.3+ 확장 기능
- 실시간 밋업 위치 공유
- 밋업 참가자 상호 평가 시스템
- 음성/영상 통화 (Stream Video SDK)
- 스토리/피드 기능 (Instagram식)
- Kindness 리더보드 & 랭킹
- Ambassador SBT 자동 티어 승급 알림
