# AlmaChat V0.3 - Kindness AI & Stability Plan

> Session 97 (2026-02-17) 수립

## Overview

V0.3은 **안정성 강화** + **Kindness AI MVP** 두 축으로 진행.
V0.2에서 구현한 소셜 기능 위에 AI 기반 밋업 리포트 자동 생성 시스템을 MVP로 구축.

---

## V0.2 잔여 작업 (V0.3에서 마무리)

| V0.2 Step | 상태 | V0.3 조치 |
|-----------|------|-----------|
| Step 4: 초대 링크 | 미완성 | 백엔드 API + 딥링크 구현 |

---

## V0.3 구현 계획 (5 Phases)

### Phase 1: 안정성 강화 ✅ (Session 97 완료)

1. **Stream Chat 401 재연결 근본 수정** ✅
   - `connectUser` → `connectUserWithProvider` 전환
   - SDK 내부 자동 토큰 갱신 활성화
   - `wsConnectionStatusStream` 감시 → 전체 재연결 폴백
   - 서버 토큰에 24시간 만료 추가

2. **온보딩 반응형 레이아웃** ✅
   - `MediaQuery` 기반 compact 모드 (screenH < 700dp)
   - 로고/폰트/슬라이드 동적 크기 조절

---

### Phase 2: 초대 링크 시스템

**목표**: 채팅방 공유 링크 생성 → 링크로 참여

**작업 내역**:

1. **Supabase 마이그레이션**: `invite_links` 테이블
   ```sql
   create table invite_links (
     id uuid primary key default gen_random_uuid(),
     code text unique not null,
     channel_id text not null,
     channel_type text default 'messaging',
     created_by text not null,
     expires_at timestamptz,
     max_uses int default 0,
     use_count int default 0,
     created_at timestamptz default now()
   );
   ```

2. **백엔드 API** (`chat/api/`):
   - `create-invite.ts`: 6자리 코드 생성, 7일 만료
   - `join-invite.ts`: 코드 검증 → `channel.addMembers()`

3. **Flutter 클라이언트**:
   - `chat_screen.dart` AppBar → 공유 아이콘 → 초대 링크 생성
   - `Share.share()` 또는 클립보드 복사
   - 딥링크 핸들러: `almachat://invite/{code}`

**예상 파일**: 4개 신규, 3개 수정

---

### Phase 3: 밋업 녹음 & 데이터 수집

**목표**: 밋업 진행 중 음성 녹음 + 사진/채팅 데이터 수집

**작업 내역**:

1. **음성 녹음 기능**
   - `record` 패키지 (Flutter audio recorder)
   - 밋업 상세 → "밋업 기록 시작" 버튼 (호스트 전용)
   - 백그라운드 녹음 지원
   - 녹음 파일 → Supabase Storage 업로드
   - 최대 2시간, AAC 포맷

2. **밋업 미디어 수집**
   - 채팅방 사진/영상 → 밋업 미디어로 자동 태깅
   - 밋업 종료 시 수집 데이터 패키지화:
     - 음성 파일 URL
     - 채팅 히스토리 (Stream API)
     - 업로드된 사진 URLs
     - 참가자 목록

3. **밋업 라이프사이클 UI**
   ```
   [예정] → [진행 중 (녹음)] → [종료 (분석 중)] → [완료 (리포트)]
   ```

**신규 패키지**: `record: ^5.x`

**예상 파일**: 3개 신규, 4개 수정

---

### Phase 4: Kindness AI 분석 엔진 (MVP)

**목표**: 수집된 데이터를 AI로 분석하여 밋업 리포트 자동 생성

**MVP 범위** (Phase 4에서):
- ✅ Speech-to-Text (음성 → 텍스트)
- ✅ 대화 요약 (AI 요약 생성)
- ✅ Kindness 점수 자동 산정
- ❌ 이미지 분석 (Phase 5+)
- ❌ 영상 하이라이트 (Phase 5+)

**작업 내역**:

1. **Vercel API 엔드포인트** (`chat/api/`):
   - `analyze-meetup.ts`: 밋업 분석 파이프라인 트리거
     ```
     Input: meetupId
     Pipeline:
       1. Supabase에서 음성 파일 URL 로드
       2. Gemini Audio API → 텍스트 변환
       3. Stream API → 채팅 히스토리 로드
       4. Gemini Flash → 대화 요약 + 기여도 분석
       5. 점수 산정 (규칙 기반 + AI 가중치)
       6. 리포트 저장 (Supabase meetup_reports)
       7. 참가자 Kindness 점수 업데이트
       8. 푸시 알림 전송
     Output: reportId
     ```

2. **Supabase 테이블**:
   - `meetup_reports`: 리포트 데이터 (요약, 점수, 미디어 참조)
   - `meetup_recordings`: 녹음 파일 메타데이터

3. **점수 산정 로직**:
   ```
   기본 점수:
     호스트: 80점
     참가자: 30점

   AI 가중치:
     참가 시간 비례: ×1.0~1.5
     발언 기여도: +10~20점 (AI 분석)
     긍정적 상호작용: +5~15점 (감정 분석)

   증빙 보너스:
     사진 업로드: +5점/장 (최대 +20)
     녹음 제공: +10점
   ```

4. **Flutter 리포트 뷰어**:
   - `meetup_report_screen.dart`: 리포트 표시
   - AI 생성 요약, 참가자별 점수, 베스트 사진
   - 홈 피드에 리포트 카드 표시

**예상 파일**: 5개 신규, 3개 수정

---

### Phase 5: 폴리싱 & 확장 (향후)

- 이미지 분석 (Gemini Vision): 활동 분류, 인원 카운트
- 영상 하이라이트 자동 편집
- 음성/영상 통화 (Stream Video SDK)
- 스토리/피드 기능
- Kindness 리더보드 인앱
- Ambassador SBT 자동 티어 승급 알림
- Play Store 배포 준비

---

## 기술 스택 (V0.3 신규)

| 컴포넌트 | 기술 | 용도 |
|----------|------|------|
| Speech-to-Text | Gemini Audio API | 음성 → 텍스트 |
| 대화 분석/요약 | Gemini 2.5 Flash | 밋업 요약 & 기여도 |
| 음성 녹음 | `record` Flutter 패키지 | 인앱 녹음 |
| 파일 저장 | Supabase Storage | 음성/사진 파일 |
| 서버 처리 | Vercel Serverless | AI 분석 파이프라인 |
| 알림 | FCM | 리포트 & 점수 알림 |

---

## 예상 일정

| Phase | 내용 | 예상 세션 |
|:-----:|------|:---------:|
| 1 | 안정성 강화 | ✅ Session 97 |
| 2 | 초대 링크 | 1~2 세션 |
| 3 | 녹음 & 데이터 수집 | 2~3 세션 |
| 4 | Kindness AI MVP | 3~4 세션 |
| 5 | 폴리싱 & 확장 | 지속적 |

---

## API 비용 예측 (MVP)

| 서비스 | 월 예상 비용 | 비고 |
|--------|:-----------:|------|
| Gemini Audio API | ~$5 | 월 50회 밋업 × 30분 녹음 |
| Gemini Flash API | ~$2 | 요약/분석 처리 |
| Supabase Storage | ~$1 | 음성 파일 (AAC 압축) |
| **총계** | **~$8** | MVP 규모 |
